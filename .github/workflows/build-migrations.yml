# .github/workflows/build-migrations.yml
name: Build & Push Migrations (tags / PR / manual)

on:
  push:
    tags:
      - 'v*'                       # build on tag pushes
  pull_request:                     # show in Actions and allow PR runs
    types: [opened, reopened, synchronize, labeled]
  workflow_dispatch:                # manual run (pick the Docker tag)
    inputs:
      imageTag:
        description: "Docker tag to push (e.g. v1.2.3)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (all tags)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Resolve image tag and head ref
        id: resolve
        shell: bash
        run: |
          set -e
          case "${{ github.event_name }}" in
            push)
              echo "Detected event: push"
              echo "tag=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
              echo "head=${GITHUB_SHA}"     >> "$GITHUB_OUTPUT"
              ;;
            pull_request)
              echo "Detected event: pull_request"
              echo "tag=pr-${{ github.event.pull_request.number }}-${GITHUB_SHA::7}" >> "$GITHUB_OUTPUT"
              echo "head=HEAD" >> "$GITHUB_OUTPUT"
              ;;
            workflow_dispatch)
              echo "Detected event: workflow_dispatch"
              echo "tag=${{ inputs.imageTag }}" >> "$GITHUB_OUTPUT"
              echo "head=HEAD"                  >> "$GITHUB_OUTPUT"
              ;;
          esac

      - name: Find previous tag (fallback to repo root)
        id: prev
        shell: bash
        run: |
          # Get sorted list of tags (most recent first)
          TAGS=$(git tag --sort=-creatordate)
          echo "All tags (newest first):"
          echo "$TAGS"

          # Get previous tag relative to the current tag if possible
          CURRENT_TAG=${{ steps.resolve.outputs.tag }}
          PREV=$(git describe --tags --abbrev=0 "${CURRENT_TAG}^" 2>/dev/null || true)

          if [ -z "$PREV" ]; then
            PREV=$(git describe --tags --abbrev=0 "$(git rev-list --tags --max-count=2)" 2>/dev/null | tail -n1 || true)
          fi

          if [ -n "$PREV" ]; then
            echo "Found previous tag: $PREV"
            echo "base=$PREV" >> "$GITHUB_OUTPUT"
            echo "PREVIOUS_TAG=$PREV" >> "$GITHUB_ENV"
          else
            ROOT=$(git rev-list --max-parents=0 HEAD | tail -n1)
            echo "No previous tag found. Using root commit: $ROOT"
            echo "base=$ROOT" >> "$GITHUB_OUTPUT"
            echo "PREVIOUS_TAG=$ROOT" >> "$GITHUB_ENV"
          fi

          echo "CURRENT_TAG=${CURRENT_TAG}" >> "$GITHUB_ENV"


      - name: Print current and previous tags
        run: |
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREVIOUS_TAG"

      - name: Detect ADDED migration files since previous tag
        id: detect
        shell: bash
        run: |
          ADDED=$(git diff --name-only --diff-filter=A \
                   "${{ steps.prev.outputs.base }}" "${{ steps.resolve.outputs.head }}" \
                   | grep '^src/db/migrations/' || true)
          echo "$ADDED"
          if [ -n "$ADDED" ]; then
            echo "added=true" >> "$GITHUB_OUTPUT"
          else
            echo "added=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Login to ACR
        if: steps.detect.outputs.added == 'true'
        uses: azure/docker-login@v1
        with:
          login-server: ${{ secrets.ACR_URL }}
          username: ${{ secrets.ACR_PUSH_USER }}
          password: ${{ secrets.ACR_PUSH_TOKEN }}

      - name: Build and push (migrations)
        if: steps.detect.outputs.added == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./migrations.Dockerfile
          push: true
          tags: ${{ secrets.ACR_URL }}/raster/${{ github.event.repository.name }}-migrations:${{ steps.resolve.outputs.tag }}

      - name: Skip (no newly added migrations)
        if: steps.detect.outputs.added != 'true'
        run: echo "No new files added under src/db/migrations/**; skipping."

      - name: Dump environment (end)
        run: env | sort

